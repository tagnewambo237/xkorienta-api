name: CI/CD Pipeline Production - Xkorienta API

on:
  push:
    branches:
      - main

env:
  NODE_ENV: production
  DOCKER_BUILDKIT: 1
  DOCKER_IMAGE: nkot20/xkorienta-api

jobs:
  # ============================================
  # Étape 1 : Build Docker Production
  # ============================================
  build:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ github.ref_name }}
            ${{ env.DOCKER_IMAGE }}:latest
          build-args: |
            NODE_ENV=production
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create source archive
        run: |
          tar -czf "${{ github.sha }}.tar.gz" --exclude=.git --exclude=node_modules --exclude=.next . || [[ $? -eq 1 ]]

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-archive
          path: ${{ github.sha }}.tar.gz
          retention-days: 1

  # ============================================
  # Étape 2 : Tests & Linting
  # ============================================
  test_unit:
    runs-on: ubuntu-latest
    needs: [build]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint || true

      - name: Run TypeScript check
        run: npx tsc --noEmit || true

  # ============================================
  # Étape 3 : Build test (vérification Next.js)
  # ============================================
  build_test:
    runs-on: ubuntu-latest
    needs: [test_unit]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Next.js build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

  # ============================================
  # Étape 4 : Déploiement PRODUCTION
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    needs: [build_test]
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Check deploy variables
        run: |
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "❌ Error: DEPLOY_PATH secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "❌ Error: DEPLOY_HOST secret is not set"
            exit 1
          fi

      - name: Create deploy archive
        run: |
          tar -czf deploy-files.tar.gz docker-compose.yml

      - name: Upload deploy files to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "=== Uploading deploy files to production server ==="
          sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p $DEPLOY_PATH"
          sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -P "$DEPLOY_PORT" deploy-files.tar.gz "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/"

      - name: Deploy to production server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DOCKER_IMAGE: ${{ env.DOCKER_IMAGE }}
        run: |
          sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" \
            "export DEPLOY_PATH='$DEPLOY_PATH'; export DOCKER_IMAGE='$DOCKER_IMAGE'; bash -s" << 'REMOTE'
          set -euo pipefail
          if [ -z "$DEPLOY_PATH" ]; then
            echo "❌ Erreur: DEPLOY_PATH est vide"; exit 2
          fi

          echo "=== [PRODUCTION] Extracting deploy files ==="
          cd "$DEPLOY_PATH"
          tar -xzf deploy-files.tar.gz docker-compose.yml

          echo "=== Mise à jour de l'image dans docker-compose ==="
          sed -i "s|image:.*|image: $DOCKER_IMAGE:main|" docker-compose.yml

          echo "=== Vérifications pré-déploiement ==="
          [ -f ".env" ] || { echo "⚠️ WARNING: .env manquant dans $DEPLOY_PATH — le container pourrait ne pas démarrer correctement"; }
          [ -f "docker-compose.yml" ] || { echo "❌ ERROR: docker-compose.yml manquant dans $DEPLOY_PATH"; exit 43; }

          echo "=== Déploiement Production (docker compose) ==="
          if docker compose version >/dev/null 2>&1; then
            echo "✓ Utilisation de docker compose (v2 plugin)"
            docker compose down || true
            docker compose pull app
            docker compose up -d
          else
            echo "⚠️ docker compose v2 absent — fallback via image docker/compose"
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD":"$PWD" -w "$PWD" docker/compose:2.30.3 down || true
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD":"$PWD" -w "$PWD" docker/compose:2.30.3 pull app
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD":"$PWD" -w "$PWD" docker/compose:2.30.3 up -d
          fi

          echo "=== Sanity check ==="
          sleep 5
          if curl -sf http://127.0.0.1:3001/api/health >/dev/null 2>&1; then
            echo "✅ Health check OK - API démarrée avec succès"
          else
            echo "⚠️ Health endpoint non disponible (vérifier les logs du container)"
          fi

          echo "=== Nettoyage Docker (safe) ==="
          docker image prune -af --filter "until=168h" || true
          docker builder prune -af || true

          echo "=== ✅ Déploiement PRODUCTION API terminé avec succès ==="
          REMOTE
