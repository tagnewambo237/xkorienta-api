name: CI/CD Pipeline Dev - Xkorienta API

on:
  push:
    branches:
      - develop

env:
  NODE_ENV: dev
  DOCKER_BUILDKIT: 1
  DOCKER_IMAGE: nkot20/xkorienta-api

jobs:
  # Étape 1 : Build Docker Dev
  build:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ github.ref_name }}
          build-args: |
            NODE_ENV=dev
          no-cache: true

      - name: Create source archive
        run: |
          # Exit code 1 from tar means "file changed as we read it" - not critical
          tar -czf "${{ github.sha }}.tar.gz" --exclude=.git --exclude=node_modules . || [[ $? -eq 1 ]]

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-archive
          path: ${{ github.sha }}.tar.gz
          retention-days: 1

  # Étape 2 : Tests unitaires et linting
  test_unit:
    runs-on: ubuntu-latest
    needs: [build]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint || true

      - name: Run TypeScript check
        run: npx tsc --noEmit || true

  # Étape 3 : Build test (vérification que le build passe)
  build_test:
    runs-on: ubuntu-latest
    needs: [test_unit]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Next.js build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: http://localhost:3001

  # Étape 4 : Déploiement sur le serveur Dev
  deploy:
    runs-on: ubuntu-latest
    needs: [build_test]
    environment: dev
    steps:
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Check deploy variables
        run: |
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "❌ Error: DEPLOY_PATH secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "❌ Error: DEPLOY_HOST secret is not set"
            exit 1
          fi

      - name: Create deploy archive
        run: |
          # Create a tarball with docker-compose.yml and .env
          tar -czf deploy-files.tar.gz docker-compose.yml .env

      - name: Upload deploy files to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "=== Uploading deploy files to server ==="
          sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p $DEPLOY_PATH"
          sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -P "$DEPLOY_PORT" deploy-files.tar.gz "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/"

      - name: Deploy to dev server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" bash -s -- "$DEPLOY_PATH" << 'REMOTE'
          set -euo pipefail
          DEPLOY_PATH="${1:-}"
          if [ -z "$DEPLOY_PATH" ]; then
            echo "Erreur: DEPLOY_PATH est vide"; exit 2
          fi

          echo "=== Pré-check serveur ==="
          systemd-detect-virt || true
          grep overlay /proc/filesystems || true
          command -v docker || true
          docker version || true

          echo "=== Auto-fix Docker (driver & DNS) ==="
          sudo mkdir -p /etc/docker
          if ! grep -q "^nodev[[:space:]]\+overlay$" /proc/filesystems || [ "$(systemd-detect-virt || true)" = "lxc" ]; then
            echo "=> overlayfs indisponible : driver VFS"
            sudo sh -c 'printf %s "
            {
              \"storage-driver\": \"vfs\",
              \"dns\": [\"1.1.1.1\", \"8.8.8.8\"]
            }
            " > /etc/docker/daemon.json'
          else
            echo "=> overlayfs dispo : overlay2 + DNS publics"
            sudo sh -c 'printf %s "
            {
              \"storage-driver\": \"overlay2\",
              \"dns\": [\"1.1.1.1\", \"8.8.8.8\"]
            }
            " > /etc/docker/daemon.json'
          fi

          echo "=== Restart Docker ==="
          sudo systemctl restart docker
          sleep 2
          docker info | egrep -i "Storage Driver|Server Version|containerd-snapshotter" || true

          echo "=== Extracting deploy files ==="
          cd "$DEPLOY_PATH"
          tar -xzf deploy-files.tar.gz
          
          echo "=== Déploiement (docker compose) ==="
          if docker compose version >/dev/null 2>&1; then
            docker compose down || true
            docker compose pull app
            docker compose up -d
          else
            echo "docker compose v2 absent — fallback via image docker/compose"
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD":"$PWD" -w "$PWD" docker/compose:2.30.3 down || true
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD":"$PWD" -w "$PWD" docker/compose:2.30.3 pull app
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD":"$PWD" -w "$PWD" docker/compose:2.30.3 up -d
          fi

          echo "=== Nettoyage (safe) sur le serveur ==="
          docker image prune -af --filter "until=168h" || true
          docker builder prune -af || true
          REMOTE
